<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banco Exchange</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800">
  <div class="min-h-screen flex items-center justify-center">
    <div class="max-w-lg mx-auto p-8">
      <form action="/api/offer" method="POST">
        <div class="grid gap-4">
          <!-- Currency Input -->
          <div class="flex items-center justify-between p-4 border-2 border-gray-300 rounded-md">
            <span class="font-semibold" value="FUSD">FUSD</span>
            <input type="hidden" name="inputCurrency" id="inputCurrency" value="FUSD">
            <input type="text" name="input" placeholder="0.0"
              class="text-right font-semibold bg-transparent outline-none">
          </div>
          <div class="text-right text-sm">~ 18750 EUR</div>

          <!-- Arrow Down -->
          <div class="flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- Currency Output -->
          <div class="flex items-center justify-between p-4 border-2 border-gray-300 rounded-md">
            <span class="font-semibold" value="USDT">USDT</span>
            <input type="hidden" name="outputCurrency" id="outputCurrency" value="USDT">
            <input type="text" name="output" placeholder="0.0"
              class="text-right font-semibold bg-transparent outline-none">
          </div>
          <div class="text-right text-sm">~ 18000 EUR</div>

          <!-- Submit Button -->
          <button disabled type="submit" id="tradeButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Connect
          </button>
        </div>
      </form>
    </div>
  </div>
  <button id="connectButton" onclick="connectMarina()" class="absolute top-0 right-0 m-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
    Connect with Marina
  </button>
</body>
<script src="https://unpkg.com/htmx.org"></script>
<script>
  window.onload = async function() {
    const isEnabled = await window.marina.isEnabled();
    const traderScript = localStorage.getItem('traderScript')

    if (isEnabled && traderScript) 
      updateViewAfterConnect(traderScript);
  }

  async function connectMarina() {
    try {
      const isEnabled = await window.marina.isEnabled();

      // Ask user for permissions
      await window.marina.enable();

      // fetch his address and script to receive funds
      const { script } = await window.marina.getNextAddress();

      // updated view
      updateViewAfterConnect(script);

      // persist state
      localStorage.setItem('traderScript', script);
    } catch (error) {
      console.error(error);
    }
  }

  function updateViewAfterConnect(script) {
     // Update buttons title
     const connectButton = document.getElementById('connectButton');
      const tradeButton = document.getElementById('tradeButton');
      connectButton.innerText = 'Connected';
      tradeButton.innerText = 'Trade';

      // Enable/disable buttons
      connectButton.disabled = true;
      tradeButton.disabled = false;

      // Attach script taken from Marina step when Trade submit button is clicked
      tradeButton.addEventListener('click', function() {
        // Attach the script to the form submission
        const form = document.querySelector('form');
        const scriptInput = document.createElement('input');
        scriptInput.type = 'hidden';
        scriptInput.name = 'traderScript';
        scriptInput.value = script;
        form.appendChild(scriptInput);
      });
  }
</script>
</html>
